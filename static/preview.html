<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CastAI - ë¯¸ë¦¬ë³´ê¸°</title>
    <link rel="stylesheet" href="/static/kiosk.css">
    <style>
        .preview-main {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2rem;
        }
        
        .preview-image-container {
            background: var(--bg-card);
            border-radius: 24px;
            padding: 2rem;
            box-shadow: 0 4px 20px var(--shadow);
            width: 100%;
            max-width: 500px;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .preview-image-container img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 16px;
            object-fit: contain;
        }
        
        .preview-placeholder {
            text-align: center;
            color: var(--text-light);
        }
        
        .preview-placeholder .icon {
            font-size: 5rem;
            margin-bottom: 1rem;
        }
        
        .loading-container {
            text-align: center;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        .loading-text {
            color: var(--text-muted);
            font-size: 1.2rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .style-selector {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .style-mini {
            background: var(--bg-cream);
            border: 3px solid transparent;
            border-radius: 12px;
            padding: 0.75rem 1.25rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            min-width: 120px;
        }
        
        .style-mini:hover {
            border-color: var(--primary-light);
            transform: translateY(-2px);
        }
        
        .style-mini.selected {
            border-color: var(--primary);
            background: var(--pastel-purple);
        }
        
        .style-mini.loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .style-mini h4 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-dark);
            margin: 0;
        }
        
        .style-mini p {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin: 0.25rem 0 0;
        }
        
        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 1rem 2rem;
            background: #fef2f2;
            border-top: 2px solid #fecaca;
            color: #dc2626;
            text-align: center;
            font-size: 1rem;
            z-index: 100;
        }
        
        .status-bar.hidden {
            display: none;
        }
        
        .status-bar .contact {
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }
    </style>
</head>
<body class="kiosk-body">
    <div class="kiosk-container">
        <header class="kiosk-header">
            <h1>CastAI</h1>
            <p>ìƒì„±ëœ ìºë¦­í„°ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”</p>
        </header>

        <div class="preview-main">
            <div class="preview-image-container" id="previewContainer">
                <div class="loading-container" id="loadingState">
                    <div class="loading-spinner"></div>
                    <p class="loading-text">ìºë¦­í„°ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                    <p class="loading-text" style="font-size: 0.9rem; margin-top: 0.5rem;">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</p>
                </div>
                
                <img id="generatedImage" class="hidden" alt="Generated character">
                
                <div class="preview-placeholder hidden" id="placeholder">
                    <div class="icon">ğŸ–¼ï¸</div>
                    <p>ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p>
                </div>
            </div>
            
            <div class="kiosk-card" style="width: 100%; max-width: 700px;">
                <h3 style="text-align: center; margin-bottom: 1rem; color: var(--text-dark);">ë‹¤ë¥¸ ìŠ¤íƒ€ì¼ë¡œ ë³€ê²½í•˜ê¸°</h3>
                <div class="style-selector" id="styleSelector">
                    <div class="style-mini" data-style="real_bubblehead">
                        <h4>ë¦¬ì–¼</h4>
                        <p>ë²„ë¸”í—¤ë“œ</p>
                    </div>
                    <div class="style-mini" data-style="semi_realistic">
                        <h4>ë°˜ì‹¤ì‚¬</h4>
                        <p>3D ìŠ¤íƒ€ì¼</p>
                    </div>
                    <div class="style-mini" data-style="character">
                        <h4>ìºë¦­í„°</h4>
                        <p>ë™í™”í’</p>
                    </div>
                    <div class="style-mini" data-style="anime">
                        <h4>ì• ë‹ˆë©”ì´ì…˜</h4>
                        <p>ì¼ë³¸í’</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="kiosk-footer" style="max-width: 700px; margin: 2rem auto 0;">
            <button class="kiosk-btn secondary" id="backBtn">ì´ì „</button>
            <div class="price-info">
                <span class="price-label">ê°€ê²©</span>
                <span class="price-value">5,000ì›</span>
            </div>
            <button class="kiosk-btn primary" id="nextBtn" disabled>
                ë‹¤ìŒ ë‹¨ê³„ë¡œ
            </button>
        </div>
    </div>

    <div class="status-bar hidden" id="statusBar">
        <div>âš ï¸ <span id="errorMessage">Stable Diffusion ì„œë²„ ì—°ê²° ì‹¤íŒ¨</span></div>
        <div class="contact">ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”</div>
    </div>

    <script>
        const previewContainer = document.getElementById('previewContainer');
        const loadingState = document.getElementById('loadingState');
        const generatedImage = document.getElementById('generatedImage');
        const placeholder = document.getElementById('placeholder');
        const styleSelector = document.getElementById('styleSelector');
        const styleMinis = document.querySelectorAll('.style-mini');
        const backBtn = document.getElementById('backBtn');
        const nextBtn = document.getElementById('nextBtn');
        const statusBar = document.getElementById('statusBar');
        const errorMessage = document.getElementById('errorMessage');

        let currentStyle = sessionStorage.getItem('selectedStyle') || 'real_bubblehead';
        let uploadedImage = sessionStorage.getItem('uploadedImage');
        let generatedImageData = null;
        let isGenerating = false;

        styleMinis.forEach(mini => {
            if (mini.dataset.style === currentStyle) {
                mini.classList.add('selected');
            }
        });

        function showError(message) {
            errorMessage.textContent = message;
            statusBar.classList.remove('hidden');
        }

        function hideError() {
            statusBar.classList.add('hidden');
        }

        function showLoading() {
            loadingState.classList.remove('hidden');
            generatedImage.classList.add('hidden');
            placeholder.classList.add('hidden');
            nextBtn.disabled = true;
        }

        function showImage(imageUrl) {
            loadingState.classList.add('hidden');
            generatedImage.src = imageUrl;
            generatedImage.classList.remove('hidden');
            placeholder.classList.add('hidden');
            nextBtn.disabled = false;
            hideError();
        }

        function showPlaceholder() {
            loadingState.classList.add('hidden');
            generatedImage.classList.add('hidden');
            placeholder.classList.remove('hidden');
            nextBtn.disabled = true;
        }

        async function checkServerHealth() {
            try {
                const response = await fetch('/api/transform/health');
                const data = await response.json();
                return data.status === 'connected';
            } catch (error) {
                return false;
            }
        }

        async function generateCharacter(style) {
            if (isGenerating) return;
            if (!uploadedImage) {
                showPlaceholder();
                showError('ì—…ë¡œë“œëœ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤');
                return;
            }

            isGenerating = true;
            showLoading();
            styleMinis.forEach(m => m.classList.add('loading'));

            try {
                const isConnected = await checkServerHealth();
                if (!isConnected) {
                    /* === BYPASS FOR TESTING ===
                    showPlaceholder();
                    showError('Stable Diffusion ì„œë²„ ì—°ê²° ì‹¤íŒ¨');
                    isGenerating = false;
                    styleMinis.forEach(m => m.classList.remove('loading'));
                    return;
                    === END BYPASS === */
                }

                const base64Data = uploadedImage.split(',')[1];

                const formData = new FormData();
                const blob = await fetch(uploadedImage).then(r => r.blob());
                formData.append('image', blob, 'photo.jpg');
                formData.append('style', style);

                const response = await fetch('/api/transform/character', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'ì´ë¯¸ì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
                }

                const data = await response.json();
                generatedImageData = data.image_url;
                showImage(generatedImageData);
                sessionStorage.setItem('generatedImage', generatedImageData);

            } catch (error) {
                console.error('Generation error:', error);
                
                /* === BYPASS FOR TESTING - Show uploaded image instead === */
                showImage(uploadedImage);
                sessionStorage.setItem('generatedImage', uploadedImage);
                /* === END BYPASS === */
                
                /* === UNCOMMENT FOR PRODUCTION ===
                showPlaceholder();
                showError(error.message || 'ì´ë¯¸ì§€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
                === END PRODUCTION CODE === */
            }

            isGenerating = false;
            styleMinis.forEach(m => m.classList.remove('loading'));
        }

        styleMinis.forEach(mini => {
            mini.addEventListener('click', () => {
                if (isGenerating) return;
                
                styleMinis.forEach(m => m.classList.remove('selected'));
                mini.classList.add('selected');
                currentStyle = mini.dataset.style;
                sessionStorage.setItem('selectedStyle', currentStyle);
                
                generateCharacter(currentStyle);
            });
        });

        backBtn.addEventListener('click', () => {
            window.location.href = '/static/style.html';
        });

        nextBtn.addEventListener('click', () => {
            window.location.href = '/static/shipping.html';
        });

        if (!uploadedImage) {
            showPlaceholder();
            showError('ì—…ë¡œë“œëœ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤. ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘í•´ì£¼ì„¸ìš”.');
        } else {
            generateCharacter(currentStyle);
        }
    </script>
</body>
</html>
